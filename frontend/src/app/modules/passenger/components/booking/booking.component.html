<!-- Booking Component Template -->
<div class="booking-container">
  <!-- Header Section -->
  <div class="header">
    <h1>Prenota il tuo Volo</h1>
    <div *ngIf="flight" class="flight-summary">
      <div class="route">
        <span class="airport">{{ flight.departureAirport?.code || 'N/A' }}</span>
        <svg class="plane-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8">
          </path>
        </svg>
        <span class="airport">{{ flight.arrivalAirport?.code || 'N/A' }}</span>
      </div>
      <div class="details">
        <span>{{ flight.departureTime | date:'dd/MM/yyyy HH:mm' }}</span>
        <span>{{ formatDuration(flight.duration) }}</span>
        <span>{{ formatPrice(basePrice) }}</span>
      </div>
    </div>
  </div>

  <!-- Step Indicator -->
  <div class="step-indicator">
    <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
      <span>1</span>
      <label>Passeggeri</label>
    </div>
    <div class="step-line"></div>
    <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
      <span>2</span>
      <label>Posti</label>
    </div>
    <div class="step-line"></div>
    <div class="step" [class.active]="currentStep === 3" [class.completed]="currentStep > 3">
      <span>3</span>
      <label>Extra</label>
    </div>
    <div class="step-line"></div>
    <div class="step" [class.active]="currentStep === 4" [class.completed]="currentStep > 4">
      <span>4</span>
      <label>Pagamento</label>
    </div>
    <div class="step-line" *ngIf="currentStep === 5"></div>
    <div class="step" *ngIf="currentStep === 5" [class.active]="currentStep === 5" [class.completed]="false">
      <span>‚úì</span>
      <label>Conferma</label>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>{{ currentStep === 1 ? 'Caricamento volo...' : 'Elaborazione prenotazione...' }}</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="status-message error">
    <svg class="error-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01"></path>
    </svg>
    <span>{{ error }}</span>
    <button class="btn-secondary" (click)="error = ''">Chiudi</button>
  </div>

  <!-- Booking Content -->
  <div class="booking-content" *ngIf="(!loading && !error) || currentStep === 5">
    <!-- Temporary Debug Info -->
    <div
      style="position: fixed; top: 10px; right: 10px; background: #f0f0f0; padding: 10px; border-radius: 5px; z-index: 1000;">
      <strong>Debug Info:</strong><br>
      Current Step: {{ currentStep }}<br>
      Loading: {{ loading }}<br>
      Error: {{ !!error }}<br>
      Booking Confirmation: {{ !!bookingConfirmation }}<br>
      <span *ngIf="bookingConfirmation">Ref: {{ bookingConfirmation.bookingReference }}</span>
    </div>

    <!-- Step 1: Passenger Information -->
    <div *ngIf="currentStep === 1" class="booking-step active">
      <div class="step-header">
        <h2>Informazioni Passeggeri</h2>
        <p>Inserisci i dati di tutti i passeggeri</p>
      </div>

      <form [formGroup]="passengersForm" class="passengers-form">
        <div formArrayName="passengers" class="passengers-list">
          <div *ngFor="let passenger of getPassengersArray().controls; let i = index" class="passenger-card"
            [formGroupName]="i">
            <h3>Passeggero {{ i + 1 }}</h3>

            <div class="form-row">
              <div class="form-group">
                <label>Nome *</label>
                <input type="text" formControlName="firstName" placeholder="Inserisci il nome">
                <div class="error" *ngIf="passenger.get('firstName')?.invalid && passenger.get('firstName')?.touched">
                  Il nome √® obbligatorio
                </div>
              </div>

              <div class="form-group">
                <label>Cognome *</label>
                <input type="text" formControlName="lastName" placeholder="Inserisci il cognome">
                <div class="error" *ngIf="passenger.get('lastName')?.invalid && passenger.get('lastName')?.touched">
                  Il cognome √® obbligatorio
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Data di Nascita *</label>
                <input type="date" formControlName="dateOfBirth" [max]="getMaxBirthDate()">
                <div class="error"
                  *ngIf="passenger.get('dateOfBirth')?.invalid && passenger.get('dateOfBirth')?.touched">
                  La data di nascita √® obbligatoria
                </div>
              </div>

              <div class="form-group">
                <label>Genere *</label>
                <select formControlName="gender">
                  <option value="">Seleziona genere</option>
                  <option value="male">Maschio</option>
                  <option value="female">Femmina</option>
                  <option value="other">Altro</option>
                </select>
                <div class="error" *ngIf="passenger.get('gender')?.invalid && passenger.get('gender')?.touched">
                  Il genere √® obbligatorio
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Numero Documento *</label>
                <input type="text" formControlName="documentNumber" placeholder="Numero passaporto">
                <div class="error"
                  *ngIf="passenger.get('documentNumber')?.invalid && passenger.get('documentNumber')?.touched">
                  Il numero documento √® obbligatorio
                </div>
              </div>

              <div class="form-group">
                <label>Email *</label>
                <input type="email" formControlName="email" placeholder="email@example.com">
                <div class="error" *ngIf="passenger.get('email')?.invalid && passenger.get('email')?.touched">
                  Email valida richiesta
                </div>
              </div>

              <div class="form-group">
                <label>Telefono *</label>
                <input type="tel" formControlName="phone" placeholder="Es: +39 123 456 7890">
                <div class="error" *ngIf="passenger.get('phone')?.invalid && passenger.get('phone')?.touched">
                  Numero di telefono richiesto
                </div>
              </div>

              <div class="form-group">
                <label>Nazionalit√† *</label>
                <select formControlName="nationality">
                  <option value="">Seleziona nazionalit√†</option>
                  <option value="IT">Italiana</option>
                  <option value="US">Americana</option>
                  <option value="GB">Britannica</option>
                  <option value="FR">Francese</option>
                  <option value="DE">Tedesca</option>
                  <option value="ES">Spagnola</option>
                  <option value="CH">Svizzera</option>
                  <option value="AT">Austriaca</option>
                  <option value="NL">Olandese</option>
                  <option value="BE">Belga</option>
                </select>
                <div class="error"
                  *ngIf="passenger.get('nationality')?.invalid && passenger.get('nationality')?.touched">
                  Seleziona la nazionalit√†
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="step-actions">
          <button type="button" class="btn-primary" [disabled]="passengersForm.invalid" (click)="nextStep()">
            Continua con la selezione posti
          </button>
        </div>
      </form>
    </div>

    <!-- Step 2: Seat Selection -->
    <div *ngIf="currentStep === 2" class="booking-step active">
      <div class="step-header">
        <h2>Seleziona i Posti</h2>
        <p>Scegli i posti per tutti i passeggeri</p>
      </div>

      <div class="seat-selection">
        <div class="seat-legend">
          <div class="legend-item">
            <div class="seat-example available economy"></div>
            <span>Economy</span>
          </div>
          <div class="legend-item">
            <div class="seat-example available business"></div>
            <span>Business</span>
          </div>
          <div class="legend-item">
            <div class="seat-example available first"></div>
            <span>Prima Classe</span>
          </div>
          <div class="legend-item">
            <div class="seat-example selected"></div>
            <span>Selezionato</span>
          </div>
          <div class="legend-item">
            <div class="seat-example occupied"></div>
            <span>Occupato</span>
          </div>
        </div>

        <div class="aircraft-layout">
          <div class="seat-map" *ngIf="seatMap">
            <div class="row" *ngFor="let row of seatMap.rows" [class]="'class-' + row.class">
              <div class="row-number">{{row.rowNumber}}</div>
              <div class="class-label" [class]="'class-' + row.class">{{ getClassLabel(row.class) }}</div>
              <div class="seat-row">
                <div *ngFor="let seat of row.seats" class="seat"
                  [class.available]="seat.isAvailable && !seat.isSelected" [class.selected]="seat.isSelected"
                  [class.occupied]="!seat.isAvailable" [class.first-class]="seat.class === 'first'"
                  [class.business-class]="seat.class === 'business'" [class.economy-class]="seat.class === 'economy'"
                  [title]="seat.seatNumber + ' - ' + getClassLabel(seat.class) + ' - ‚Ç¨' + seat.price"
                  (click)="selectSeat(seat.seatNumber)">
                  {{seat.seatNumber.slice(-1)}}
                </div>
              </div>
              <div class="row-number">{{row.rowNumber}}</div>
            </div>
          </div>
        </div>

        <div class="selected-seats" *ngIf="selectedSeats.length > 0">
          <h3>Posti Selezionati:</h3>
          <div class="selected-seats-list">
            <span *ngFor="let seat of selectedSeats; let i = index" class="selected-seat">
              {{ seat }} ({{ getSeatClass(seat) }}) - ‚Ç¨{{ getSeatPrice(seat) }}
            </span>
          </div>
        </div>

        <div class="step-actions">
          <button type="button" class="btn-secondary" (click)="previousStep()">
            Indietro
          </button>
          <button type="button" class="btn-primary" [disabled]="selectedSeats.length !== getPassengersArray().length"
            (click)="nextStep()">
            Continua con il pagamento
          </button>
        </div>
      </div>
    </div>

    <!-- Step 3: Extra Services -->
    <!-- Step 3: Extra Services -->
    <div *ngIf="currentStep === 3" class="booking-step active">
      <div class="step-header">
        <h2>Servizi Extra</h2>
        <p>Seleziona i servizi aggiuntivi per il tuo viaggio</p>
      </div>

      <!-- Flight Services Info -->
      <div class="flight-services" *ngIf="availableExtras.hasWifi || availableExtras.hasEntertainment">
        <h3>Servizi Inclusi</h3>
        <div class="included-services">
          <div class="service" *ngIf="availableExtras.hasWifi">
            <svg class="service-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0">
              </path>
            </svg>
            <span>Wi-Fi gratuito</span>
          </div>
          <div class="service" *ngIf="availableExtras.hasEntertainment">
            <svg class="service-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m0 0V1a1 1 0 011-1h2a1 1 0 011 1v18a1 1 0 01-1 1V1a1 1 0 011-1h2a1 1 0 011 1v3z">
              </path>
            </svg>
            <span>Intrattenimento di bordo</span>
          </div>
        </div>
      </div>

      <!-- Extra Services Selection -->
      <div class="extra-services-section">
        <h3>Servizi Aggiuntivi</h3>

        <!-- Extra Baggage -->
        <div class="service-option" *ngIf="availableExtras.extraBaggage.available">
          <div class="service-header">
            <div class="service-info">
              <h4>Bagaglio Aggiuntivo</h4>
              <p>Max {{ availableExtras.extraBaggage.maxWeight }}kg per bagaglio</p>
            </div>
            <div class="service-price">‚Ç¨{{ availableExtras.extraBaggage.price }} per bagaglio</div>
          </div>
          <div class="service-controls">
            <button type="button" class="quantity-btn" (click)="updateExtraBaggage(selectedExtras.extraBaggage - 1)"
              [disabled]="selectedExtras.extraBaggage <= 0">-</button>
            <span class="quantity">{{ selectedExtras.extraBaggage }}</span>
            <button type="button" class="quantity-btn"
              (click)="updateExtraBaggage(selectedExtras.extraBaggage + 1)">+</button>
          </div>
        </div>

        <!-- Travel Insurance -->
        <div class="service-option">
          <div class="service-header">
            <div class="service-info">
              <h4>Assicurazione di Viaggio</h4>
              <p>Copre cancellazione, ritardi e bagagli smarriti</p>
            </div>
            <div class="service-price">‚Ç¨25</div>
          </div>
          <div class="service-controls">
            <label class="checkbox-container">
              <input type="checkbox" [checked]="selectedExtras.insurance" (change)="toggleInsurance()">
              <span class="checkmark"></span>
              <span>Aggiungi assicurazione</span>
            </label>
          </div>
        </div>

        <!-- Priority Boarding -->
        <div class="service-option">
          <div class="service-header">
            <div class="service-info">
              <h4>Imbarco Prioritario</h4>
              <p>Salta la coda e imbarcati per primo</p>
            </div>
            <div class="service-price">‚Ç¨15</div>
          </div>
          <div class="service-controls">
            <label class="checkbox-container">
              <input type="checkbox" [checked]="selectedExtras.priorityBoarding" (change)="togglePriorityBoarding()">
              <span class="checkmark"></span>
              <span>Aggiungi imbarco prioritario</span>
            </label>
          </div>
        </div>

        <!-- Extra Legroom -->
        <div class="service-option">
          <div class="service-header">
            <div class="service-info">
              <h4>Spazio Gambe Extra</h4>
              <p>Maggiore comfort con posti a spazio gambe aumentato</p>
            </div>
            <div class="service-price">‚Ç¨35</div>
          </div>
          <div class="service-controls">
            <label class="checkbox-container">
              <input type="checkbox" [checked]="selectedExtras.extraLegroom" (change)="toggleExtraLegroom()">
              <span class="checkmark"></span>
              <span>Aggiungi spazio gambe extra</span>
            </label>
          </div>
        </div>
      </div>

      <div class="step-actions">
        <button type="button" class="btn-secondary" (click)="previousStep()">
          Indietro
        </button>
        <button type="button" class="btn-primary" (click)="nextStep()">
          Continua al pagamento
        </button>
      </div>
    </div> <!-- Step 4: Payment -->
    <div *ngIf="currentStep === 4" class="booking-step active">
      <div class="step-header">
        <h2>Pagamento</h2>
        <p>Conferma e completa la prenotazione</p>
      </div>

      <div class="payment-section">
        <div class="virtual-wallet">
          <div class="wallet-card">
            <h3>üí≥ Portafoglio Virtuale</h3>
            <div class="balance">
              <span class="balance-label">Saldo disponibile:</span>
              <span class="balance-amount">‚Ç¨2,000.00</span>
            </div>
            <p class="wallet-note">Il pagamento verr√† elaborato dal tuo portafoglio virtuale</p>
          </div>
        </div>

        <div class="price-summary">
          <h3>Riepilogo Prenotazione</h3>
          <div class="price-breakdown">
            <div class="price-item">
              <span>Volo base ({{ getPassengersArray().length }} {{ getPassengersArray().length === 1 ? 'passeggero' :
                'passeggeri' }})</span>
              <span>‚Ç¨{{ priceBreakdown.basePrice }}</span>
            </div>
            <div class="price-item" *ngIf="priceBreakdown.seatPrice > 0">
              <span>Selezione posti</span>
              <span>‚Ç¨{{ priceBreakdown.seatPrice }}</span>
            </div>
            <div class="price-item" *ngFor="let extra of priceBreakdown.extras">
              <span>{{ extra.name }}</span>
              <span>‚Ç¨{{ extra.price }}</span>
            </div>
            <div class="price-item">
              <span>Tasse e commissioni</span>
              <span>‚Ç¨{{ priceBreakdown.taxes }}</span>
            </div>
            <div class="price-item total">
              <span>Totale</span>
              <span>‚Ç¨{{ priceBreakdown.total }}</span>
            </div>
          </div>
        </div>

        <div class="step-actions">
          <button type="button" class="btn-secondary" (click)="previousStep()">
            Indietro
          </button>
          <button type="button" class="btn-primary" [disabled]="loading" (click)="confirmBooking()">
            <div class="spinner" *ngIf="loading"></div>
            {{ loading ? 'Elaborazione...' : 'Conferma Prenotazione' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Step 5: Success -->
    <div *ngIf="currentStep === 5" class="booking-step success-step active">
      <div class="success-container">
        <!-- Success Animation & Icon -->
        <div class="success-header">
          <div class="success-icon-container">
            <div class="success-icon-bg"></div>
            <svg class="success-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <h1>üéâ Prenotazione Confermata!</h1>
          <p class="success-message">La tua prenotazione √® stata completata con successo</p>
        </div>

        <!-- Booking Summary Card -->
        <div class="booking-summary-card" *ngIf="bookingConfirmation">
          <div class="card-header">
            <h3>Dettagli Prenotazione</h3>
            <div class="booking-reference">
              <span class="ref-label">Codice</span>
              <span class="ref-value">{{ bookingConfirmation.bookingReference }}</span>
            </div>
          </div>

          <!-- Flight Information -->
          <div class="flight-summary" *ngIf="flight">
            <div class="flight-route">
              <div class="airport-info">
                <span class="airport-code">{{ flight.departureAirport?.code || 'N/A' }}</span>
                <span class="airport-city">{{ flight.departureAirport?.city || 'N/A' }}</span>
              </div>
              <div class="route-line">
                <div class="plane-icon">‚úàÔ∏è</div>
                <div class="route-duration">{{ formatDuration(flight.duration) }}</div>
              </div>
              <div class="airport-info">
                <span class="airport-code">{{ flight.arrivalAirport?.code || 'N/A' }}</span>
                <span class="airport-city">{{ flight.arrivalAirport?.city || 'N/A' }}</span>
              </div>
            </div>

            <div class="flight-details-grid">
              <div class="detail-item">
                <span class="label">üìÖ Data partenza</span>
                <span class="value">{{ flight.departureTime | date:'dd MMM yyyy' }}</span>
              </div>
              <div class="detail-item">
                <span class="label">üïê Orario partenza</span>
                <span class="value">{{ flight.departureTime | date:'HH:mm' }}</span>
              </div>
              <div class="detail-item">
                <span class="label">‚úàÔ∏è Volo</span>
                <span class="value">{{ flight.flightNumber }}</span>
              </div>
              <div class="detail-item">
                <span class="label">üí∫ Posti selezionati</span>
                <span class="value">{{ selectedSeats.join(', ') || 'N/A' }}</span>
              </div>
            </div>
          </div>

          <!-- Passenger Information -->
          <div class="passenger-info">
            <h4>üë• Passeggeri ({{ getPassengersArray().length }})</h4>
            <div class="passenger-list">
              <div *ngFor="let passenger of getPassengersArray().controls; let i = index" class="passenger-item">
                <span class="passenger-name">{{ passenger.get('firstName')?.value }} {{ passenger.get('lastName')?.value
                  }}</span>
                <span class="passenger-seat">Posto {{ selectedSeats[i] || 'N/A' }}</span>
              </div>
            </div>
          </div>

          <!-- Price Summary -->
          <div class="price-summary">
            <h4>üí∞ Riepilogo Costi</h4>
            <div class="price-breakdown">
              <div class="price-item">
                <span>Volo base</span>
                <span>‚Ç¨{{ priceBreakdown.basePrice }}</span>
              </div>
              <div class="price-item" *ngIf="priceBreakdown.seatPrice > 0">
                <span>Selezione posti</span>
                <span>‚Ç¨{{ priceBreakdown.seatPrice }}</span>
              </div>
              <div class="price-item" *ngFor="let extra of priceBreakdown.extras">
                <span>{{ extra.name }}</span>
                <span>‚Ç¨{{ extra.price }}</span>
              </div>
              <div class="price-item">
                <span>Tasse e commissioni</span>
                <span>‚Ç¨{{ priceBreakdown.taxes }}</span>
              </div>
              <div class="price-item total">
                <span>Totale pagato</span>
                <span>‚Ç¨{{ priceBreakdown.total }}</span>
              </div>
            </div>
          </div>

          <!-- Contact Information -->
          <div class="contact-info">
            <div class="info-item">
              <span class="label">üìß Email di conferma inviata a:</span>
              <span class="value">{{ getPassengersArray().controls[0]?.get('email')?.value }}</span>
            </div>
            <div class="info-item">
              <span class="label">üì± Telefono di contatto:</span>
              <span class="value">{{ getPassengersArray().controls[0]?.get('phone')?.value }}</span>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="success-actions">
          <button type="button" class="btn btn-primary btn-large" (click)="goToBookings()">
            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
              </path>
            </svg>
            Visualizza le mie prenotazioni
          </button>
          <button type="button" class="btn btn-outline btn-large" (click)="searchNewFlight()">
            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            Cerca un nuovo volo
          </button>
        </div>
      </div>
    </div>
  </div>