<div class="user-management">
  <div class="page-header">
    <div class="header-content">
      <h1>
        <mat-icon>people</mat-icon>
        Gestione Utenti
      </h1>
      <p>Amministra gli utenti registrati sulla piattaforma</p>
    </div>
  </div>

  <!-- Filters -->
  <mat-card class="filters-card">
    <mat-card-header>
      <mat-card-title>Filtri di Ricerca</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="filters-grid">
        <mat-form-field appearance="outline">
          <mat-label>Cerca per email o nome</mat-label>
          <input matInput [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange()"
            placeholder="Inserisci termine di ricerca">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Filtra per ruolo</mat-label>
          <mat-select [(value)]="selectedRole" (selectionChange)="onFilterChange()">
            <mat-option value="">Tutti i ruoli</mat-option>
            <mat-option value="admin">Amministratori</mat-option>
            <mat-option value="passenger">Passeggeri</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Filtra per stato</mat-label>
          <mat-select [(value)]="selectedStatus" (selectionChange)="onFilterChange()">
            <mat-option value="">Tutti gli stati</mat-option>
            <mat-option value="active">Attivi</mat-option>
            <mat-option value="inactive">Inattivi</mat-option>
          </mat-select>
        </mat-form-field>

        <div class="filter-actions">
          <button class="btn-secondary" (click)="clearFilters()">
            <mat-icon>clear</mat-icon>
            Pulisci Filtri
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Error Message -->
  <div class="status-message error" *ngIf="error && !loading">
    <mat-icon>error</mat-icon>
    <span>{{ error }}</span>
  </div>

  <!-- Users Table -->
  <mat-card class="users-table-card" *ngIf="!loading; else loadingTemplate">
    <mat-card-header>
      <mat-card-title>Utenti Sistema</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="table-container" *ngIf="users.length > 0; else emptyTemplate">
        <table mat-table [dataSource]="users" class="users-table">
          <!-- Email Column -->
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef>Email</th>
            <td mat-cell *matCellDef="let user">{{ user.email }}</td>
          </ng-container>

          <!-- First Name Column -->
          <ng-container matColumnDef="firstName">
            <th mat-header-cell *matHeaderCellDef>Nome</th>
            <td mat-cell *matCellDef="let user">{{ user.firstName }}</td>
          </ng-container>

          <!-- Last Name Column -->
          <ng-container matColumnDef="lastName">
            <th mat-header-cell *matHeaderCellDef>Cognome</th>
            <td mat-cell *matCellDef="let user">{{ user.lastName }}</td>
          </ng-container>

          <!-- Role Column -->
          <ng-container matColumnDef="role">
            <th mat-header-cell *matHeaderCellDef>Ruolo</th>
            <td mat-cell *matCellDef="let user">
              <mat-chip [color]="getRoleColor(user.role)" selected>
                {{ getRoleText(user.role) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="isActive">
            <th mat-header-cell *matHeaderCellDef>Stato</th>
            <td mat-cell *matCellDef="let user">
              <mat-chip [color]="user.isActive ? 'primary' : 'accent'" selected>
                {{ user.isActive ? 'Attivo' : 'Inattivo' }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Wallet Balance Column -->
          <ng-container matColumnDef="walletBalance">
            <th mat-header-cell *matHeaderCellDef>Portafoglio</th>
            <td mat-cell *matCellDef="let user">
              <span class="wallet-balance" *ngIf="user.role === 'passenger'">
                {{ user.walletBalance | currency:'EUR':'symbol':'1.2-2' }}
              </span>
              <span class="wallet-balance not-applicable" *ngIf="user.role !== 'passenger'">
                N/A
              </span>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Azioni</th>
            <td mat-cell *matCellDef="let user">
              <button mat-icon-button class="btn-secondary" (click)="toggleUserStatus(user)"
                [disabled]="user.role === 'admin'" [matTooltip]="user.isActive ? 'Disattiva utente' : 'Attiva utente'">
                <mat-icon>{{ user.isActive ? 'block' : 'check_circle' }}</mat-icon>
              </button>
              <button mat-icon-button class="btn-danger" (click)="deleteUser(user)" [disabled]="user.role === 'admin'"
                matTooltip="Elimina utente">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination-container" *ngIf="totalPages > 1">
        <mat-paginator [length]="totalUsers" [pageSize]="pageSize" [pageSizeOptions]="[5, 10, 20, 50]"
          [pageIndex]="currentPage - 1" (page)="onPageChange($event.pageIndex + 1)" showFirstLastButtons>
        </mat-paginator>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Loading Template -->
  <ng-template #loadingTemplate>
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Caricamento utenti in corso...</p>
    </div>
  </ng-template>

  <!-- Empty Template -->
  <ng-template #emptyTemplate>
    <div class="empty-state">
      <mat-icon>people</mat-icon>
      <h3>Nessun utente trovato</h3>
      <p>Inizia invitando una compagnia aerea</p>
    </div>
  </ng-template>
</div>